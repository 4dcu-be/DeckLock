{% extends 'base.html' %}
{% import 'macros/casting_cost.html' as casting_cost %}

{% block title %}
{{ SITENAME }} - M:tG Overview
{% endblock %}

{% block social_media_meta %}
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ SITEURL }}/{{ output_file }}">
<meta property="og:title" content="DeckLock for Magic: the Gathering - Overview">
<meta property="og:description" content="Overview of {{ articles|selectattr("category", "equalto", "MTG_Deck")|list|length  }} M:tG Decks">
<meta property="og:image" content="{{ SITEURL }}/theme/img/DeckLock_mtg.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="{{ SITEURL }}/{{ output_file }}">
<meta property="twitter:title" content="DeckLock for Magic: the Gathering - Overview">
<meta property="twitter:description" content="Overview of {{ articles|selectattr("category", "equalto", "MTG_Deck")|list|length  }} M:tG Decks">
<meta property="twitter:image" content="{{ SITEURL }}/theme/img/DeckLock_mtg.png">
{% endblock %}

{% block extra_css %}
<link href="{{ SITEURL }}/theme/css/mana-cost.css" rel="stylesheet" />
{% endblock extra_css %}

{% block container %}

    <ol class="breadcrumb mt-3">
      <li class="breadcrumb-item"><a href="{{ SITEURL }}/index.html">DeckLock</a></li>
      <li class="breadcrumb-item active">Magic: The Gathering</li>
    </ol>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Magic: The Gathering Decks</h1>
        <input type="text" class="form-control w-auto" id="deck-search" placeholder="Search decks..." aria-label="Search decks">
    </div>

    {%- set mtg_decks = articles|selectattr("category", "equalto", "MTG_Deck")|list -%}
    {%- set formats = {} -%}
    {%- for deck in mtg_decks -%}
        {%- if deck.format not in formats -%}
            {%- set _ = formats.update({deck.format: []}) -%}
        {%- endif -%}
        {%- set _ = formats[deck.format].append(deck) -%}
    {%- endfor -%}

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Decks</h6>
                    <h2 class="card-title mb-0 text-primary">{{ mtg_decks|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Formats</h6>
                    <h2 class="card-title mb-0 text-success">{{ formats|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Format Breakdown</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {%- for format, decks in formats.items()|sort -%}
                        <span class="badge bg-secondary">{{ format }}: {{ decks|length }}</span>
                        {%- endfor -%}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
    <table id="deck_overview" class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th scope="col" data-sort="string-ins">Deck</th>
            <th scope="col" data-sort="string-ins">Format</th>
            <th scope="col" class="text-end">Colors</th>
        </tr>
        </thead>
        <tbody>
        {% for a in articles|rejectattr('format', 'undefined')|sort(attribute='name')|sort(attribute='format') %}
            {% if a.category == "MTG_Deck" %}
            <tr class="deck-row">
                <td><a href="{{ SITEURL }}/{{ a.url }}" class="text-decoration-none fw-semibold">{{ a.name }}</a></td>
                <td><span class="badge bg-secondary">{{ a.format }}</span></td>
                <td class="text-end">{{ casting_cost.parse(a.deck.colors_string) }}</td>
            </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ SITEURL }}/theme/js/stupidtable.min.js"></script>
<script>
// Table sorting
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('deck_overview');
  if (typeof stupidtable !== 'undefined') {
    stupidtable.init(table);
  }

  // Search functionality
  const searchInput = document.getElementById('deck-search');
  const tableRows = document.querySelectorAll('.deck-row');

  searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();

    tableRows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
});
</script>
{% endblock %}